# LAB: Implementation of Azure Load Balancer

Ab hum Azure Load Balancer ki end-to-end LAB karne ja rhe hain. 

**Scenario**:

Hum 2 windows VMs create karenge, dono pe IIS installed hoga aur dono ```Windows VM-1``` aur ```Windows VM-2``` text render karenge. Inke front pe ek load balancer hoga jo dono vms par load ko balance karega.

<br>
<br>

### LAB Goal

Hum Azure mein:
- 1 Virtual Network banayenge.
- 2 Windows Server VMs banayenge same Vnet ke ander.
- Dono pe IIS install karenge
- Simple webpage configure karenge:
  - VM1 â†’ "Windows Server 1".
  - VM2 â†’ "Windows Server 2".
- Inke front pe Azure Load Balancer lagayenge.
- Backend pool mein dono VMs add karenge.
- Health probe configure karenge.
- Load balancing rule configure karenge.
- Browser se verify karenge ki traffic distribute ho raha hai.

<br>
<br>

### Architecture Diagram

```
Internet
    |
Public IP (Load Balancer)
    |
Azure Load Balancer
    |
Backend Pool
   |        |
 VM1      VM2
 IIS      IIS
```

<br>
<br>

### Step-by-Step Implementation

<br>

**STEP 1 â€“ Resource Group Create Karna**:

Azure Portal:
- Go to Resource Groups.
- Click Create.
- Name: ```rg-lb-demo```.
- Region: Central India (ya jo bhi near ho).
- Create

Same region mein saare components hone chahiye.

<br>

**STEP 2 â€“ Virtual Network Create Karna**:

VMs ko ek network mein connect karne ke liye.

Create VNet:
- Name: ```vnet-lb-demo```.
- Address Space: ```10.0.0.0/24```.
- Subnet:
  - Name: ```subnet-web```
  - Address range: ```10.0.1.0/24```.
 
<br>

**STEP 3 â€“ Create VM1**:

Basic Settings:
- Name: ```vm-web-1```.
- Image: Windows Server 2019/2022.
- Size: B2s (demo ke liye).
- Username/password set karo.
- Public IP: None (IMPORTANT â€” direct internet access nahi denge).

Network:
- VNet: ```vnet-lb-demo```.
- Subnet: ```subnet-web```.
- Create.

<br>

**STEP 4 â€“ Create VM2**:

Same configuration:
- Name: ```vm-web-2```.
- Same VNet.
- Same subnet
- No Public IP.

<br>

**STEP 5 â€“ NSG Configuration**:

Because VMs ke paas public IP nahi hai, RDP kaise karenge?

Temporary:
- Ek jumpbox bana sakte ho.
- OR.
- Load Balancer NAT rule use kar sakte ho.

For simplicity:
- Letâ€™s create a temporary public IP for VM1 for setup, baad mein remove kar dena.

Allow:
- RDP (3389).
- HTTP (80).

<br>

**STEP 6 â€“ Install IIS on Both VMs**:

RDP into VM1:
- Opne Server Manager.
- Install IIS Role.

Then modify default page:
- Go to:
- ```C:\inetpub\wwwroot```.
- Edit ```iisstart.htm```.
- Replace content:
- ```<h1>Windows Server 1</h1>```.

Now VM2 pe same karo but:
```
<h1>Windows Server 2</h1>
```

<br>

**Test Individually (Before LB)**

VMs ki IP ko browser mein hit karo.

VM1 IP:

ðŸ‘‰ Windows Server 1.

VM2 IP:

ðŸ‘‰ Windows Server 2

Ab hume pata hai dono working hain.

<br>

**STEP 7 â€“ Create Azure Load Balancer**:

Type: Public Load Balancer

Configuration:
- Name: ```lb-web-demo```.
- SKU: Standard.
- Type: Public.
- Public IP: New create karo.
  - Name: ```pip-lb-web```.
 
Create.

<br>

**STEP 8 â€“ Backend Pool Configuration**:

Load Balancer â†’ Backend Pools â†’ Add

Name: ```backend-web-pool```.

Add:
- ```vm-web-1```.
- ```vm-web-2```.

<br>

**STEP 9 â€“ Health Probe Configuration**:

Why?
- Load balancer ko kaise pata chalega VM alive hai?

Create Probe:
- Name: ```http-probe```.
- Protocol: HTTP.
- Port: 80.
- Path: ```/```.
- Interval: 5 seconds.
- Threshold: 2.

<br>

**STEP 10 â€“ Load Balancing Rule Create Karna**:

Go to:
- Load Balancing Rules â†’ Add.

- Name: ```http-rule```.
- Frontend IP: Public IP
- Backend pool: backend-web-pool
- Protocol: TCP
- Port: 80
- Backend Port: 80
- Health Probe: http-probe
- Session Persistence: None.

Create.

<br>

**Load Balancer Setup Ready**:

Ab tumhara Load Balancer Setup ready hai.

Tu Load Balancer ke public ip ko access karke dekhoge to traffic backend vms par jayega.

Opne the browser and paste the public ip of Load Balancer:
```
http://20.204.227.36/
```

Output:
```
Hello from Web Server - 2 (Windows) 
```

Traffic Web Server-2 pe ja rha hai.

<br>
<br>

### Traffic Flow Explanation

Now letâ€™s deeply understand what happens when user browser open karta hai:

**Step 1**:

User enters:
```
http://<LoadBalancerPublicIP>
```

**Step 2**:
- DNS resolve hota hai â†’ Load Balancer public IP.

**Step 3**:
- Packet Azure datacenter mein enter karta hai.

**Step 4**:

Load Balancer:
- Checks backend pool.
- Checks health probe results.
- Picks one healthy VM.

**Step 5**:
- Traffic forwarded internally to:
  - VM1 OR VM2.
 
**Step 6**:
- VM response returns through LB back to user.

<br>
<br>

### Load Balancing Algorithm

Azure Load Balancer uses:
- 5-Tuple Hash.

Load Balancer incoming request ke packet mein se 5 chize use karke backend vm decide karta hai:
- Source IP.
- Source Port.
- Destination IP.
- Destination Port.
- Protocol.

<br>
<br>

### Failure Simulation

Stop VM1.

Health probe detect karega:
- 2 failed attempts.
- VM1 marked unhealthy.

Now all traffic VM2 pe jayega.

This is High Availability.

<br>
<br>

### Basic VS Standard Load Balancer in Azure.

Azure mein jab aap Load Balancer create karte ho, toh aapko "SKU" (Stock Keeping Unit) choose karni hoti hai: Basic ya Standard.

**Security (By Default)**:

Ye sabse bada aur zaruri difference hai:

**Basic**: 
- Ye "Open by Default" hota hai. Matlab agar aapne ise banaya, toh internet se koi bhi ise hit kar sakta hai jab tak aap Network Security Group (NSG) se ise lock na karo.
- Iska matlab hai ki Basic Load Balancer mein NSG ka option nahi hota hai.

**Standard**:
- Ye "Secure by Default" hai. Jab tak aap ek NSG (Network Security Group) bana kar traffic allow nahi karoge, ye kisi ko entry nahi dega.
- Iska matlab hai ki Standard Load Balancer mein NSG ka option by default aata hai, jab tak aap nsg mein port open nhi karoge tab tak request backend vm tak forward nhi ho payegi.

<br>
<br>

## Azure Load Balancer â€“ Inbound NAT Rule

Inbound NAT Rule ek 1:1 port mapping hoti hai jo Load Balancer ke frontend IP ke ek specific port ko kisi ek backend VM ke specific port par map karti hai.

Matlab Load Balancer ke front end ip ko backend vm ke kisi port se map karti hai.

Yeh load balancing nahi karta.

Yeh sirf:
- Port translation karta hai.
- Direct access deta hai specific VM ko.

<br>
<br>

### Problem Statement â€“ NAT Rule Kyun Zaroori Hai?

Tumhare paas:
- 2 Windows VMs hain.
- Dono pe RDP (port 3389) allow hai NSG se.
- Dono ke paas public IP nahi hai. Sirf private ip hi hai.
- Front mein ek hi Public IP hai (Load Balancer ka).

Ab sawal:
- Jab dono vms pe public ip nhi hai to VMs ko RDP ke through access kaise karoge.

Yahi kaam karta hai Inbound NAT Rule. Ye ek "Port Mapping" ki tarah hai.

Solution:
- Hum ek NAT rule banayenge, jisme likhenge ki Agar koi Load Balancer ke IP par port ```50001``` se aaye -> Use ```VM-1``` ke port ```3389``` par bhej do. Iska matlab Load Balancer ki public ip se ```50001``` port lagakar hum VM-1 ko RDP se access kar sakte hain.
- Aur agar koi Load Balancer ke IP par port ```50002``` se aaye to use ```VM-2``` ke port ```3389``` par bhej do.

Ese kaam aata hai NAT rule, ye load balancer ki IP ke port ko vm ke kisi bhi port ko map kar sakta hai.

<br>
<br>

### Example: LAB: Inbount NAT rule in Load Balancer.

Suppose Aapke paas ek Virtual Network hai jisme 2 VMs hain: VM-01, VM-02:
- In dono VMs ke paas sirf Private IP hai (e.g., ```10.0.0.4```, ```10.0.0.5```). Koi Public IP nahi hai.
- Aapke paas ek Standard Load Balancer hai jiska Public IP hai: ```52.20.30.40```.


**Goal**:
- Aapko apne laptop se in dono VMs ka RDP session lena hai.

**Problem**:
- Jab VM ke paas agar koi public Ip nhi hoti hai to hum vm ko RDP se connect nahi kar sakte hain, load balancer ke case mein.

Agar load balancer ka case nahi hai aur case VPN ka hai to vpn ke through hum vms ko unki private ip se hi connect karte hain.

<br>

**Step-by-Step Configuration**:

1 - Frontend IP Configuration: 
- Sabse pehle Load Balancer par ek Public IP set hota hai. Hamare case mein: ```52.20.30.40```.

2 - Backend Pool:
- Aapne dono VMs (VM-01, VM-02) ko Load Balancer ke Backend Pool mein daal diya.

3 - Creating Inbound NAT Rules:

Ab aap Load Balancer par 2 alag-alag rules banaoge:
| | **Rule Name**   | **Frontend Port** | **Backend VM** | **Target Port (RDP)** | |
|:---:|:---:|:---:|:---:|:---:|:---:|
| | **RDP-to-VM01** | `50001` | VM-01 | `3389` | |
| | **RDP-to-VM02** | `50002` | VM-02 | `3389` | |
| | **RDP-to-VM03** | `50003` | VM-03 | `3389` | |


DONE !!!.

<br>

### End-to-End Flow: Kaise Connect Karenge?:

Ab jab aap apne laptop se RDP client (Remote Desktop Connection) khologe, toh aap ye steps follow karoge:

Case A: VM-01 se connect karna hai:
- Aap RDP mein address daloge: ```52.20.30.40:50001```.
- Request Load Balancer tak jayegi.
- Load Balancer dekhega: "Achha, port ```50001``` par request aayi hai. Mere rule ke mutabiq mujhe isse ```VM-01``` ke port 3389 par bhej dena chahiye."
- Aapka connection VM-01 se jud jayega.

Case B: VM-02 se connect karna hai:
- Aap RDP mein address daloge: ```52.20.30.40:50002```.
- Load Balancer ise redirect kar dega ```VM-02``` ke port 3389 par.
- Aapka connection ```VM-02``` se jud jayega.

<br>
<br>

### Ye Important Kyu Hai? (Advantages)
- **Cost Saving**: Aapko har VM ke liye alag Public IP kharidne ki zaroorat nahi hai. Ek hi Public IP se kaam chal gaya.
- **Security**: Aapke servers internet par directly exposed nahi hain. Sirf wahi ports khule hain jo aapne NAT rules mein define kiye hain.
- **Centralized Control**: Aap ek hi jagah (Load Balancer) se manage kar sakte ho ki kaunse VM ka access dena hai aur kaunsa band karna hai.
